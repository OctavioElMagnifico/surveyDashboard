<!DOCTYPE html>
<html lang="en">
 <head>
 <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <title>Dashboard: Real Food Information.</title>
        <script type="text/javascript" src="https://unpkg.com/d3@5.15.0/dist/d3.js"> </script>
        <script type="text/javascript" src="https://unpkg.com/lodash@4.17.15/lodash.js"></script>

       <style type="text/css">
       </style>


    </head>
    <body>
        <script type="text/javascript">

          async function predictProduce ( practicesSelected ) {
            return fetch('/rexec', {
              method: 'POST',
              headers: {
                'content-type': 'application/json'
              },
              body: JSON.stringify({
                script: 'predictProduce.R',
                arguments: [ practicesSelected ],
                output: 'fruitsDynamic.csv'
              })
            })
          };

          exSelectedPractices = [ "organic", "non_gmo", "irrigation" ]

          var parseRow = function(d) {
            return{
              id: d.id,
              value: parseFloat(d.value),
              fruit: d.fruit,
              parameter: d.parameter,
            }
          };

          var color = d3.scaleOrdinal( d3.schemeCategory10 );


          var ancho = 1000;
          var alto = 500;
          var amortig = 20;
          var valorMax = 10;
          var llave = function(d) {
            return d.id;
          }
          var svg = d3.select("body").
                       append("svg").
                       attr("width", ancho).
                       attr("height",alto);

          var fruitsList = [ 'grape', 'lettuce' ]
          var cellPadding = 100;

          var fruitsPositions = {
            grape: 0,
            lettuce: 50,
          }

          file1 = "/csv/fruits1.csv";
          file2 = "/csv/fruits2.csv";
          fileD = "/csv/fruitsDynamic.csv";

          var draw = function( file )
          {
            var escalaX;
            var excalaY;

            d3.csv(file , parseRow)
              .then( function(dataFile) {
                datos = dataFile;
                escalaX = d3.scaleBand().
                             domain( d3.range( datos.length ) ).
                             range( [0,ancho - cellPadding*( fruitsList.length - 1 ) ] ).
                             round(true).
                             paddingInner(0.01)
                escalaY = d3.scaleLinear().
                             domain(
                               [ 0, d3.max( datos, (d) => d.value ) ]
                             ).
                             range( [ 0, alto ] )

                var rects = svg.selectAll("rect")
                               .data( datos, llave )

                rects
                               .enter()
                               .append("rect")
                               .attr("x", function(d,i)
                                 { return escalaX( i ) + fruitsPositions[d.fruit]; }
                               )
                               .attr("width", escalaX.bandwidth() / 2 )
                               .attr("height",alto)
                               .attr("fill", (d,i) => color( i )
                               )
                               .merge(rects)
                               .transition()
                               .duration(1000)
                               .attr("y", function(d)
                                 {return alto - escalaY( d.value );}
                               )
                ;
                svg.selectAll("text").
                    data( datos, llave ).
                    enter().
                    append("text").
                    text( function(d) {
                      return Math.round(d.value);
                    }
                    ).
                    attr("x", function(d,i)
                      { return escalaX(i) + escalaX.bandwidth() / 2 + fruitsPositions[ d.fruit ] ; }
                    ).
                    attr("y", function(d)
                      { if (d.value>6)
                      { return alto - escalaY( d.value ) + 14; } else
                        {return alto - escalaY(d.value) - 1;};
                        ;}).
                    attr("text-anchor", "middle").
                    attr("fill","magenta").
                    attr("font-family", "sans-serif").
                    attr("font-size","14px")
                ;
              }
              );
            /* Means drawing */
            d3.csv( "/csv/fruitsMeansEx.csv" , parseRow)
              .then( function(dataFile) {
                datos = dataFile;

                var rects = svg.selectAll("rect")
                               .data( datos, llave )

                rects
                               .enter()
                               .append("rect")
                               .attr("x", function(d,i)
                                 { return escalaX( i ) + fruitsPositions[d.fruit] + escalaX.bandwidth() / 2; }
                               )
                               .attr("width", escalaX.bandwidth() / 2 )
                               .attr("height",alto)
                               .attr("fill", color( 10 )  )
                               .attr("class", (d) => d.parameter )
                               .merge(rects)
                               .transition()
                               .duration(1000)
                               .attr("y", function(d)
                                 {return alto - escalaY( d.value );}
                               )
                ;
                svg.selectAll("text").
                    data( datos, llave ).
                    enter().
                    append("text").
                    text( function(d) {
                      return Math.round(d.value);
                    }
                    ).
                    attr("x", function(d,i)
                      { return escalaX(i) + escalaX.bandwidth() / 2 + fruitsPositions[ d.fruit ] ; }
                    ).
                    attr("y", function(d)
                      { if (d.value>6)
                      { return alto - escalaY( d.value ) + 14; } else
                        {return alto - escalaY(d.value) - 1;};
                        ;}).
                    attr("text-anchor", "middle").
                    attr("fill","magenta").
                    attr("font-family", "sans-serif").
                    attr("font-size","14px")
                ;
              }
              );
          };

          var datos;
          var escalaX;
          var escalaY;
          draw( file1 )
          console.log(datos)

        </script>
    </body>
</html>
